

# Fix: Allow Suffixed Event IDs in EMQ Validator

## Problem

The `isValidEventId()` regex in `emqValidator.ts` (line 51) rejects valid three-part event IDs like `sold:{uuid}:{dealKey}` and `appt:{uuid}:{suffix}` generated by `wmTracking.ts`. This is a false positive -- the data is correct, the validator is too strict.

## Root Cause

Current deterministic pattern:
```text
/^[a-z_]+:[0-9a-f]{8}-...-[0-9a-f]{12}$/i
```
This matches `prefix:uuid` but not `prefix:uuid:suffix`.

## Fix (1 file, 1 line)

**`src/lib/emqValidator.ts` -- line 51**

Update the deterministic regex to allow an optional colon-separated suffix:

```text
Before:
/^[a-z_]+:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i

After:
/^[a-z_]+:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}(:.+)?$/i
```

The `(:.+)?` suffix is optional and allows any characters after a colon delimiter. This passes for:
- `sold:aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee` (two-part, existing)
- `sold:aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee:audit-deal-xyz` (three-part, currently rejected)
- `appt:aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee:1718901234567` (three-part, currently rejected)

Also update the comment on line 50 to reflect the expanded format:

```text
Before:
// Legacy fallback: event_type:uuid (e.g., "lead_captured:uuid") -- accepted but no longer recommended

After:
// Deterministic format: prefix:uuid or prefix:uuid:suffix (e.g., "sold:uuid:dealKey")
```

## What Does NOT Change

- The primary UUID pattern (line 49) is untouched
- No changes to `wmTracking.ts`, `gtm.ts`, or any other file
- The EMQ scoring logic is unaffected
- All existing valid event IDs continue to pass

## Verification

After the fix, the Full-Funnel Audit page (`/admin/full-funnel-audit`) should show green checkmarks for `wm_sold` and `wm_appointment_booked` Event IDs.
