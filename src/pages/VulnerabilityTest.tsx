import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ROUTES } from '@/config/navigation';
import { SEO } from '@/components/SEO';
import { Navbar } from '@/components/home/Navbar';
import { QuizHero } from '@/components/quiz/QuizHero';
import { QuizQuestion } from '@/components/quiz/QuizQuestion';
import { QuizReveal } from '@/components/quiz/QuizReveal';
import { QuizResults } from '@/components/quiz/QuizResults';
import { LeadCaptureModal } from '@/components/conversion/LeadCaptureModal';
import { useSessionData } from '@/hooks/useSessionData';
import { usePageTracking } from '@/hooks/usePageTracking';
import type { SourceTool } from '@/types/sourceTool';
import { trackToolCompletion } from '@/lib/gtm';
import { quizQuestions, calculateVulnerabilityLabel } from '@/data/quizData';
import { MinimalFooter } from '@/components/navigation/MinimalFooter';
import { getSmartRelatedTools, getFrameControl } from '@/config/toolRegistry';
import { RelatedToolsGrid } from '@/components/ui/RelatedToolsGrid';
import { getToolPageSchemas, getBreadcrumbSchema } from '@/lib/seoSchemas';

type Phase = 'hero' | 'question' | 'reveal' | 'results';

interface UserAnswer {
  questionId: string;
  answerId: string;
  confidence: number;
  isCorrect: boolean;
}

export default function VulnerabilityTest() {
  usePageTracking('vulnerability-test');
  const navigate = useNavigate();
  const { sessionData, updateFields, markToolCompleted } = useSessionData();

  const [phase, setPhase] = useState<Phase>('hero');
  const [currentStep, setCurrentStep] = useState(0);
  const [answers, setAnswers] = useState<UserAnswer[]>([]);
  const [currentAnswer, setCurrentAnswer] = useState<{ answerId: string; confidence: number } | null>(null);
  const [isAnimating, setIsAnimating] = useState(false);
  const [direction, setDirection] = useState<'forward' | 'back'>('forward');
  const [showLeadCapture, setShowLeadCapture] = useState(false);

  const currentQuestion = quizQuestions[currentStep];
  const totalQuestions = quizQuestions.length;

  // Calculate score from answers
  const score = answers.filter((a) => a.isCorrect).length;

  const handleStart = () => {
    setPhase('question');
  };

  const handleAnswer = (answerId: string, confidence: number) => {
    const isCorrect = currentQuestion.options.find((o) => o.id === answerId)?.isCorrect || false;
    
    setCurrentAnswer({ answerId, confidence });
    
    // Record the answer
    setAnswers((prev) => [
      ...prev,
      {
        questionId: currentQuestion.id,
        answerId,
        confidence,
        isCorrect,
      },
    ]);

    // Show reveal
    setDirection('forward');
    setIsAnimating(true);
    setTimeout(() => {
      setPhase('reveal');
      setIsAnimating(false);
    }, 300);
  };

  const handleContinueFromReveal = () => {
    if (currentStep < totalQuestions - 1) {
      // Go to next question
      setDirection('forward');
      setIsAnimating(true);
      setTimeout(() => {
        setCurrentStep((prev) => prev + 1);
        setCurrentAnswer(null);
        setPhase('question');
        setIsAnimating(false);
      }, 300);
    } else {
      // Show results
      const finalScore = answers.filter((a) => a.isCorrect).length;
      const vulnerability = calculateVulnerabilityLabel(finalScore);
      
      // Save to session
      updateFields({
        quizScore: finalScore,
        quizVulnerability: vulnerability,
        quizAttempted: true,
      });
      markToolCompleted('vulnerability-test');

      // Track tool completion
      trackToolCompletion({ toolName: 'vulnerability-test', score: finalScore });

      setPhase('results');
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setDirection('back');
      setIsAnimating(true);
      setTimeout(() => {
        // Remove the last answer
        setAnswers((prev) => prev.slice(0, -1));
        setCurrentStep((prev) => prev - 1);
        setCurrentAnswer(null);
        setPhase('question');
        setIsAnimating(false);
      }, 300);
    }
  };

  const handleGetAnswerKey = () => {
    setShowLeadCapture(true);
  };

  const handleLeadSuccess = (leadId: string) => {
    updateFields({ leadId });
    setShowLeadCapture(false);
  };

  // Get the last answer for the current question (for reveal phase)
  const lastAnswer = answers[answers.length - 1];

  return (
    <div className="min-h-screen bg-background relative">
      <SEO
        title="Window Sales Vulnerability Quiz"
        description="Take this 6-question quiz to discover how vulnerable you are to high-pressure window sales tactics. Get your vulnerability score and learn your weak spots."
        canonicalUrl="https://itswindowman.com/vulnerability-test"
        jsonLd={[...getToolPageSchemas('vulnerability-test'), getBreadcrumbSchema('vulnerability-test')]}
      />
      <Navbar />

      {/* Main content */}
      <div className="pt-14">
        {phase === 'hero' && <QuizHero onStart={handleStart} />}

      {phase === 'question' && currentQuestion && (
        <QuizQuestion
          question={currentQuestion}
          currentStep={currentStep}
          totalSteps={totalQuestions}
          onAnswer={handleAnswer}
          onBack={handleBack}
          isAnimating={isAnimating}
          direction={direction}
        />
      )}

      {phase === 'reveal' && lastAnswer && currentAnswer && (
        <QuizReveal
          question={quizQuestions[currentStep]}
          userAnswerId={currentAnswer.answerId}
          userConfidence={currentAnswer.confidence}
          onContinue={handleContinueFromReveal}
        />
      )}

        {phase === 'results' && (
          <QuizResults
            score={score}
            totalQuestions={totalQuestions}
            onGetAnswerKey={handleGetAnswerKey}
          />
        )}
      </div>

      {/* Lead Capture Modal */}
      <LeadCaptureModal
        isOpen={showLeadCapture}
        onClose={() => setShowLeadCapture(false)}
        onSuccess={handleLeadSuccess}
        sourceTool={'vulnerability-test' satisfies SourceTool}
        sessionData={sessionData}
      />

      {/* Related Tools */}
      <RelatedToolsGrid
        title={getFrameControl('vulnerability-test').title}
        description={getFrameControl('vulnerability-test').description}
        tools={getSmartRelatedTools('vulnerability-test', sessionData.toolsCompleted)}
      />

      {/* Minimal Footer */}
      <MinimalFooter />
    </div>
  );
}
