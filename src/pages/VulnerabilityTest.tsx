import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Home } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { ROUTES } from '@/config/navigation';
import { QuizHero } from '@/components/quiz/QuizHero';
import { QuizQuestion } from '@/components/quiz/QuizQuestion';
import { QuizReveal } from '@/components/quiz/QuizReveal';
import { QuizResults } from '@/components/quiz/QuizResults';
import { LeadCaptureModal } from '@/components/conversion/LeadCaptureModal';
import { useSessionData } from '@/hooks/useSessionData';
import { usePageTracking } from '@/hooks/usePageTracking';
import { trackToolCompletion } from '@/lib/gtm';
import { quizQuestions, calculateVulnerabilityLabel } from '@/data/quizData';
import { MinimalFooter } from '@/components/navigation/MinimalFooter';

type Phase = 'hero' | 'question' | 'reveal' | 'results';

interface UserAnswer {
  questionId: string;
  answerId: string;
  confidence: number;
  isCorrect: boolean;
}

export default function VulnerabilityTest() {
  usePageTracking('vulnerability-test');
  const navigate = useNavigate();
  const { sessionData, updateFields, markToolCompleted } = useSessionData();

  const [phase, setPhase] = useState<Phase>('hero');
  const [currentStep, setCurrentStep] = useState(0);
  const [answers, setAnswers] = useState<UserAnswer[]>([]);
  const [currentAnswer, setCurrentAnswer] = useState<{ answerId: string; confidence: number } | null>(null);
  const [isAnimating, setIsAnimating] = useState(false);
  const [direction, setDirection] = useState<'forward' | 'back'>('forward');
  const [showLeadCapture, setShowLeadCapture] = useState(false);

  const currentQuestion = quizQuestions[currentStep];
  const totalQuestions = quizQuestions.length;

  // Calculate score from answers
  const score = answers.filter((a) => a.isCorrect).length;

  const handleStart = () => {
    setPhase('question');
  };

  const handleAnswer = (answerId: string, confidence: number) => {
    const isCorrect = currentQuestion.options.find((o) => o.id === answerId)?.isCorrect || false;
    
    setCurrentAnswer({ answerId, confidence });
    
    // Record the answer
    setAnswers((prev) => [
      ...prev,
      {
        questionId: currentQuestion.id,
        answerId,
        confidence,
        isCorrect,
      },
    ]);

    // Show reveal
    setDirection('forward');
    setIsAnimating(true);
    setTimeout(() => {
      setPhase('reveal');
      setIsAnimating(false);
    }, 300);
  };

  const handleContinueFromReveal = () => {
    if (currentStep < totalQuestions - 1) {
      // Go to next question
      setDirection('forward');
      setIsAnimating(true);
      setTimeout(() => {
        setCurrentStep((prev) => prev + 1);
        setCurrentAnswer(null);
        setPhase('question');
        setIsAnimating(false);
      }, 300);
    } else {
      // Show results
      const finalScore = answers.filter((a) => a.isCorrect).length;
      const vulnerability = calculateVulnerabilityLabel(finalScore);
      
      // Save to session
      updateFields({
        quizScore: finalScore,
        quizVulnerability: vulnerability,
        quizAttempted: true,
      });
      markToolCompleted('vulnerability-test');

      // Track tool completion
      trackToolCompletion({ toolName: 'vulnerability-test', score: finalScore });

      setPhase('results');
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setDirection('back');
      setIsAnimating(true);
      setTimeout(() => {
        // Remove the last answer
        setAnswers((prev) => prev.slice(0, -1));
        setCurrentStep((prev) => prev - 1);
        setCurrentAnswer(null);
        setPhase('question');
        setIsAnimating(false);
      }, 300);
    }
  };

  const handleGetAnswerKey = () => {
    setShowLeadCapture(true);
  };

  const handleLeadSuccess = (leadId: string) => {
    updateFields({ leadId });
    setShowLeadCapture(false);
  };

  // Get the last answer for the current question (for reveal phase)
  const lastAnswer = answers[answers.length - 1];

  return (
    <div className="min-h-screen bg-background relative">
      {/* Header - only on hero and results */}
      {(phase === 'hero' || phase === 'results') && (
        <header className="absolute top-0 left-0 right-0 z-20 p-4">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => navigate(ROUTES.HOME)}
            className="text-muted-foreground hover:text-foreground"
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            <Home className="w-4 h-4" />
          </Button>
        </header>
      )}

      {/* Main content */}
      {phase === 'hero' && <QuizHero onStart={handleStart} />}

      {phase === 'question' && currentQuestion && (
        <QuizQuestion
          question={currentQuestion}
          currentStep={currentStep}
          totalSteps={totalQuestions}
          onAnswer={handleAnswer}
          onBack={handleBack}
          isAnimating={isAnimating}
          direction={direction}
        />
      )}

      {phase === 'reveal' && lastAnswer && currentAnswer && (
        <QuizReveal
          question={quizQuestions[currentStep]}
          userAnswerId={currentAnswer.answerId}
          userConfidence={currentAnswer.confidence}
          onContinue={handleContinueFromReveal}
        />
      )}

      {phase === 'results' && (
        <QuizResults
          score={score}
          totalQuestions={totalQuestions}
          onGetAnswerKey={handleGetAnswerKey}
        />
      )}

      {/* Lead Capture Modal */}
      <LeadCaptureModal
        isOpen={showLeadCapture}
        onClose={() => setShowLeadCapture(false)}
        onSuccess={handleLeadSuccess}
        sourceTool="vulnerability-test"
        sessionData={sessionData}
      />

      {/* Minimal Footer */}
      <MinimalFooter />
    </div>
  );
}
